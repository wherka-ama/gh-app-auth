name: Release

on:
  release:
    types: [prereleased]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Install tools (if needed)
        run: |
          # Check if envsubst is available, install only if missing
          if ! command -v envsubst &> /dev/null; then
            echo "envsubst not found, installing gettext-base..."
            sudo apt-get update && sudo apt-get install -y gettext-base
          else
            echo "envsubst is already available"
          fi

      - name: Run tests
        run: go test ./...

      - name: Build release binaries and packages
        run: |
          # Set version from tag (strip 'v' prefix for package version)
          VERSION="${GITHUB_REF_NAME#v}"
          export VERSION
          export RPM_RELEASE=1
          echo "Building version: $VERSION"
          echo "RPM release: $RPM_RELEASE"

          make release packages

          # List all built artifacts
          echo ""
          echo "=== Built artifacts ==="
          ls -lh dist/

          # Display package metadata
          echo "=== DEB Package Info ==="
          for deb in dist/*.deb; do
            echo "--- $deb ---"
            dpkg-deb -I "$deb" | grep -E "(Package|Version|Architecture|Maintainer)"
          done

          echo ""
          echo "=== RPM Package Info ==="
          for rpm in dist/*.rpm; do
            echo "--- $rpm ---"
            rpm -qip "$rpm" 2>/dev/null | grep -E "(Name|Version|Release|Architecture|Group)" || \
              echo "rpm command not available for detailed info"
          done
      - name: Upload artifacts and set release as latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"

          # Note: the relase is assumed as created as prerelease
          # The following section is aimmed at pushing the artifacts to the release
          # and promoting it to latest

          echo "Uploading artifacts to release $VERSION..."
          gh release upload "$VERSION" dist/* --clobber

          echo "Setting release as latest..."
          gh release edit "$VERSION" --prerelease=false --latest
