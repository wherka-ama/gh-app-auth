name: 'Setup GitHub App Auth'
description: 'Configure GitHub App authentication with automatic cleanup for non-ephemeral runners'
branding:
  icon: 'lock'
  color: 'blue'

inputs:
  # Single app mode (legacy - still supported)
  app-id:
    description: 'GitHub App ID (use for single app setup)'
    required: false
  private-key:
    description: 'GitHub App private key (PEM format, use for single app setup)'
    required: false
  patterns:
    description: 'Repository patterns (comma-separated, e.g., "github.com/org1/*,github.com/org2/*")'
    required: false
  app-name:
    description: 'Friendly name for the GitHub App'
    required: false
    default: 'GitHub App'

  # Multi-app mode (recommended for multiple organizations)
  apps-config:
    description: |
      JSON array of GitHub App configurations for multi-org setup.
      Format: [{"app-id": "123", "private-key": "...", "patterns": "github.com/org/*", "app-name": "Org App"}]
      Either specify this OR the individual app-id/private-key/patterns inputs.
    required: false

  # Common options
  cleanup-on-exit:
    description: 'Remove credentials from keyring on job completion (important for non-ephemeral runners)'
    required: false
    default: 'true'
  sync-git-config:
    description: 'Automatically sync git credential helper configuration'
    required: false
    default: 'true'
  extension-version:
    description: 'Version of gh-app-auth to install (default: latest from main branch)'
    required: false
    default: ''

outputs:
  config-path:
    description: 'Path to the gh-app-auth configuration file'
    value: ${{ steps.setup.outputs.config-path }}
  cleanup-registered:
    description: 'Whether cleanup hook was registered'
    value: ${{ steps.setup.outputs.cleanup-registered }}

runs:
  using: 'composite'
  steps:
    - name: Install required tools
      shell: bash
      run: |
        # Install GitHub CLI if not present
        if ! command -v gh &> /dev/null; then
          echo "ðŸ“¦ Installing GitHub CLI..."
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
          echo "âœ… GitHub CLI installed"
        else
          echo "âœ… GitHub CLI already installed"
        fi

        # Install jq for JSON parsing (needed for multi-app mode)
        if ! command -v jq &> /dev/null; then
          echo "ðŸ“¦ Installing jq..."
          sudo apt update && sudo apt install jq -y
          echo "âœ… jq installed"
        else
          echo "âœ… jq already installed"
        fi

    - name: Install gh-app-auth extension
      shell: bash
      run: |
        echo "ðŸ“¦ Installing gh-app-auth extension..."

        if [ -n "${{ inputs.extension-version }}" ]; then
          gh extension install AmadeusITGroup/gh-app-auth --pin "${{ inputs.extension-version }}"
        else
          gh extension install AmadeusITGroup/gh-app-auth || gh extension upgrade app-auth || true
        fi

        echo "âœ… gh-app-auth extension installed"
        gh app-auth --version

    - name: Setup GitHub App authentication
      id: setup
      shell: bash
      run: |
        echo "ðŸ” Configuring GitHub App authentication..."

        # Determine which mode: single or multi-app
        if [ -n "${{ inputs.apps-config }}" ]; then
          echo "ðŸ“‹ Multi-app mode: Configuring multiple GitHub Apps from JSON"

          # Parse JSON and configure each app
          echo '${{ inputs.apps-config }}' | jq -c '.[]' | while read -r app; do
            app_id=$(echo "$app" | jq -r '."app-id"')
            app_name=$(echo "$app" | jq -r '."app-name" // "GitHub App"')
            patterns=$(echo "$app" | jq -r '.patterns')
            private_key=$(echo "$app" | jq -r '."private-key"')

            echo ""
            echo "ðŸ”§ Configuring: $app_name (ID: $app_id)"
            echo "   Patterns: $patterns"

            # Configure app with private key from JSON
            export GH_APP_PRIVATE_KEY="$private_key"
            gh app-auth setup \
              --app-id "$app_id" \
              --patterns "$patterns" \
              --name "$app_name"
            unset GH_APP_PRIVATE_KEY

            echo "âœ… Configured: $app_name"
          done

          echo ""
          echo "âœ… All GitHub Apps configured"
        else
          echo "ðŸ“ Single-app mode: Configuring one GitHub App"

          # Validate required inputs for single-app mode
          if [ -z "${{ inputs.app-id }}" ] || [ -z "${{ inputs.private-key }}" ] || [ -z "${{ inputs.patterns }}" ]; then
            echo "âŒ Error: For single-app mode, app-id, private-key, and patterns are required"
            echo "   Or use apps-config for multi-app setup"
            exit 1
          fi

          # Setup with encrypted storage (keyring)
          export GH_APP_PRIVATE_KEY="${{ inputs.private-key }}"
          gh app-auth setup \
            --app-id "${{ inputs.app-id }}" \
            --patterns "${{ inputs.patterns }}" \
            --name "${{ inputs.app-name }}"
          unset GH_APP_PRIVATE_KEY

          echo "âœ… GitHub App configured"
        fi

        # Output config path
        config_path="$HOME/.config/gh/extensions/gh-app-auth/config.yml"
        echo "config-path=$config_path" >> $GITHUB_OUTPUT

    - name: Sync git credential helper
      if: inputs.sync-git-config == 'true'
      shell: bash
      run: |
        echo "ðŸ”„ Syncing git credential helper configuration..."
        gh app-auth gitconfig --sync --global
        echo "âœ… Git credential helper configured"

    - name: Register cleanup hook
      if: inputs.cleanup-on-exit == 'true'
      shell: bash
      run: |
        echo "ðŸ§¹ Registering cleanup hook for job completion..."

        # Create cleanup script
        cleanup_script="${RUNNER_TEMP}/gh-app-auth-cleanup.sh"
        cat > "$cleanup_script" << 'EOF'
        #!/bin/bash
        echo "ðŸ§¹ Cleaning up gh-app-auth configuration..."

        # Remove git credential helper configuration
        if command -v gh &> /dev/null && gh extension list | grep -q app-auth; then
          echo "  ðŸ—‘ï¸  Removing git credential helpers..."
          gh app-auth gitconfig --clean --global 2>/dev/null || true

          echo "  ðŸ—‘ï¸  Removing app configuration..."
          gh app-auth remove --all --force 2>/dev/null || true
        fi

        echo "âœ… Cleanup complete"
        EOF

        chmod +x "$cleanup_script"

        # Register cleanup using GitHub Actions post-job hook
        # The cleanup will run even if the job fails
        echo "$cleanup_script" >> "${RUNNER_TEMP}/cleanup_commands.txt"

        # Also set up trap for immediate cleanup on script exit
        trap "$cleanup_script" EXIT

        echo "cleanup-registered=true" >> $GITHUB_OUTPUT
        echo "âœ… Cleanup hook registered"
        echo "   Script: $cleanup_script"

    - name: Verify setup
      shell: bash
      run: |
        echo "âœ… Setup complete!"
        echo ""
        echo "ðŸ“‹ Configuration summary:"
        gh app-auth list
        echo ""
        echo "ðŸŽ¯ You can now use git commands with GitHub App authentication:"
        echo "   git clone https://github.com/org/repo"
        echo "   git submodule update --init --recursive"
        echo ""
        if [ "${{ inputs.cleanup-on-exit }}" == "true" ]; then
          echo "ðŸ§¹ Cleanup is enabled - credentials will be removed on job completion"
        fi

# Post-job cleanup (runs after all steps, even on failure)
# Note: This is a workaround as GitHub Actions doesn't have native post-job hooks
# The cleanup is registered via trap and cleanup_commands.txt
